<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>NovaPredict — Prédictions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background:#0b0f14; color:#e6edf3; }
    header { padding: 24px; border-bottom:1px solid #1f2937; display:flex; justify-content:space-between; align-items:center;}
    .brand { font-weight:700; letter-spacing:.3px; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .controls { display:flex; gap:12px; margin-bottom:16px; flex-wrap: wrap; }
    input, select, button {
      background:#0f1720; color:#e6edf3; border:1px solid #223042; border-radius:10px; padding:10px 12px;
    }
    table { width:100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
    th, td { padding:12px; border-bottom:1px solid #1f2937; text-align:left; }
    th { background: #101826; }
    .badge { font-size:12px; padding:4px 8px; border-radius:8px; border:1px solid #2f4a66; white-space:nowrap; }
    .ok { color:#22c55e; border-color:#14532d; }
    .warn { color:#f59e0b; border-color:#7c4a03; }
    .danger { color:#ef4444; border-color:#7f1d1d; }
    .muted { color:#9aa4af; }
    .pill { background:#0f1720; border:1px solid #223042; border-radius:999px; padding:6px 10px; font-size:12px;}
  </style>
  <script>
    window.API_BASE = "https://ia-sport.onrender.com";
  </script>
</head>
<body>
  <header>
    <div class="brand">NovaPredict (beta)</div>
    <div class="badge">Front v2</div>
  </header>
  <div class="wrap">
    <div class="controls">
      <input id="date" type="date" />
      <select id="league">
        <option value="">Toutes ligues</option>
        <option value="L1">Ligue 1</option>
      </select>
      <select id="version">
        <option value="auto">Version : auto (ml > elo > baseline)</option>
        <option value="ml-v1">ml-v1</option>
        <option value="elo-v1">elo-v1</option>
        <option value="baseline-v1">baseline-v1</option>
      </select>
      <button id="load">Charger</button>
      <span id="meta" class="pill muted"></span>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>Date</th><th>Ligue</th><th>Match</th>
          <th>p(1)</th><th>p(N)</th><th>p(2)</th>
          <th>Over2.5</th><th>Pick</th><th>Modèles</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const fmt = (x)=> x==null ? "-" : (Math.round(Number(x)*1000)/10)+"%";
    const todayISO = new Date().toISOString().slice(0,10);
    date.value = todayISO;

    function groupByMatch(rows){
      // Regroupe par match_id (ou fallback par clé home|away|date)
      const g = new Map();
      for (const r of rows){
        const key = r.match_id ?? `${r.match_date}|${r.home}|${r.away}`;
        if(!g.has(key)) g.set(key, {meta: {date:r.match_date, league:r.league_id, home:r.home, away:r.away}, versions:{}});
        g.get(key).versions[r.version || "unknown"] = r;
      }
      return [...g.values()];
    }

    function pickVersion(vmap, desired){
      if (desired && desired !== "auto" && vmap[desired]) return {name:desired, row:vmap[desired]};
      if (vmap["ml-v1"]) return {name:"ml-v1", row:vmap["ml-v1"]};
      if (vmap["elo-v1"]) return {name:"elo-v1", row:vmap["elo-v1"]};
      if (vmap["baseline-v1"]) return {name:"baseline-v1", row:vmap["baseline-v1"]};
      // first available
      const k = Object.keys(vmap)[0];
      return k ? {name:k, row:vmap[k]} : {name:"-", row:null};
    }

    function issueFromRow(r){
      if(!r) return "-";
      const arr = [
        {k:"1", v:Number(r.p_home ?? 0)},
        {k:"N", v:Number(r.p_draw ?? 0)},
        {k:"2", v:Number(r.p_away ?? 0)},
      ];
      arr.sort((a,b)=> b.v-a.v);
      return arr[0].k;
    }

    function disagreement(vmap){
      // Vrai si au moins deux versions ne donnent pas la même issue
      const picks = [];
      for (const [name,row] of Object.entries(vmap)){
        if (!row) continue;
        picks.push(issueFromRow(row));
      }
      const set = new Set(picks);
      return set.size > 1;
    }

    async function load(){
      const params = new URLSearchParams();
      if (date.value) params.set("date", date.value);
      if (league.value) params.set("league", league.value);
      const url = `${window.API_BASE}/predictions?${params.toString()}`;
      const t0 = performance.now();
      const res = await fetch(url);
      const data = await res.json();
      const ms = Math.round(performance.now()-t0);

      const groups = groupByMatch(data);
      const tb = document.querySelector("#tbl tbody");
      tb.innerHTML = "";

      for (const g of groups){
        const {meta, versions} = g;
        const chosen = pickVersion(versions, version.value);
        const r = chosen.row;
        const pick = issueFromRow(r);

        const badge = disagreement(versions)
          ? '<span class="badge danger">Désaccord</span>'
          : '<span class="badge ok">OK</span>';

        tb.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${meta.date}</td>
            <td>${meta.league ?? "-"}</td>
            <td>${meta.home} — ${meta.away} <span class="muted">(${chosen.name})</span></td>
            <td>${fmt(r?.p_home)}</td>
            <td>${fmt(r?.p_draw)}</td>
            <td>${fmt(r?.p_away)}</td>
            <td>${fmt(r?.p_over25)}</td>
            <td><span class="badge">${pick}</span></td>
            <td>${badge}</td>
          </tr>
        `);
      }

      const cnt = groups.length;
      meta.textContent = `${cnt} matchs • ${ms} ms • ${new Date().toLocaleTimeString()}`;
    }

    document.getElementById('load').onclick = load;
    document.getElementById('version').onchange = load;
    load();
  </script>
</body>
</html>
